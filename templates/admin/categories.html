{% extends 'base.html' %}

{% block title %}Manage Categories - Admin - Smart Service Desk{% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <h1>Manage Categories</h1>
        <p>Create, edit, and manage service request categories.</p>
    </div>

    <!-- Add New Category -->
    <div class="card mb-6">
        <div class="card-header">
            <h3>Add New Category</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin.add_category') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="d-flex gap-4" style="flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                        <label for="name" class="form-label">Category Name *</label>
                        <input type="text" id="name" name="name" class="form-control" placeholder="e.g., Security"
                            required minlength="2" maxlength="50">
                    </div>

                    <div class="form-group" style="flex: 2; min-width: 300px; margin-bottom: 0;">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" id="description" name="description" class="form-control"
                            placeholder="Brief description of this category" maxlength="200">
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                        Add Category
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Categories List -->
    <div class="card">
        <div class="card-header">
            <h3>All Categories ({{ categories|length }})</h3>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if categories %}
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Requests</th>
                            <th>Created By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cat in categories %}
                        <tr>
                            <td><strong>{{ cat.name }}</strong></td>
                            <td>{{ cat.description or '-' }}</td>
                            <td>
                                {% if cat.is_active %}
                                <span class="badge badge-resolved">Active</span>
                                {% else %}
                                <span class="badge"
                                    style="background: var(--gray-200); color: var(--gray-600);">Inactive</span>
                                {% endif %}
                            </td>
                            <td>{{ cat.usage_count }}</td>
                            <td>{{ cat.creator_name }}</td>
                            <td>
                                <div class="d-flex gap-2">
                                    <!-- Edit Modal Trigger -->
                                    <button type="button" class="btn btn-secondary btn-sm"
                                        onclick="showEditModal({{ cat.category_id }}, '{{ cat.name }}', '{{ cat.description or '' }}')">
                                        Edit
                                    </button>

                                    <!-- Toggle Active -->
                                    <form method="POST"
                                        action="{{ url_for('admin.toggle_category', category_id=cat.category_id) }}"
                                        style="margin: 0;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit"
                                            class="btn btn-sm {% if cat.is_active %}btn-secondary{% else %}btn-primary{% endif %}">
                                            {% if cat.is_active %}Deactivate{% else %}Activate{% endif %}
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <p>No categories found. Add your first category above.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div id="editModal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeEditModal()"></div>
    <div class="modal-content">
        <div class="card" style="max-width: 500px; margin: 0 auto;">
            <div class="card-header">
                <h3>Edit Category</h3>
                <button type="button" class="btn btn-secondary btn-sm" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="card-body">
                <form id="editForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="form-group">
                        <label for="edit_name" class="form-label">Category Name *</label>
                        <input type="text" id="edit_name" name="name" class="form-control" required minlength="2"
                            maxlength="50">
                    </div>

                    <div class="form-group">
                        <label for="edit_description" class="form-label">Description</label>
                        <input type="text" id="edit_description" name="description" class="form-control"
                            maxlength="200">
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        position: relative;
        z-index: 1001;
        width: 100%;
        padding: 1rem;
    }
</style>

<script>
    function showEditModal(categoryId, name, description) {
        document.getElementById('editForm').action = '/admin/categories/' + categoryId + '/update';
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_description').value = description;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeEditModal();
        }
    });
</script>
{% endblock %}