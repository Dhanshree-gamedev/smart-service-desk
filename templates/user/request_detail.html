{% extends 'base.html' %}

{% block title %}Request #{{ request.request_id }} - Smart Service Desk{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="{{ url_for('user.my_requests') }}" class="btn btn-secondary btn-sm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            Back to My Requests
        </a>
    </div>

    <!-- Request Header -->
    <div class="card mb-6">
        <div class="card-body">
            <div class="request-header">
                <div>
                    <div class="request-id">Request #{{ request.request_id }}</div>
                    <h1 style="font-size: 1.5rem; margin-bottom: 0.5rem;">{{ request.title }}</h1>
                </div>
                <div class="d-flex gap-2" style="flex-wrap: wrap;">
                    <!-- Priority Badge -->
                    {% if request.priority == 'Critical' %}
                    <span class="badge badge-priority-critical">{{ request.priority }}</span>
                    {% elif request.priority == 'High' %}
                    <span class="badge badge-priority-high">{{ request.priority }}</span>
                    {% elif request.priority == 'Medium' %}
                    <span class="badge badge-priority-medium">{{ request.priority }}</span>
                    {% else %}
                    <span class="badge badge-priority-low">{{ request.priority }}</span>
                    {% endif %}

                    <!-- Status Badge -->
                    {% if request.status == statuses[0] %}
                    <span class="badge badge-submitted">{{ request.status }}</span>
                    {% elif request.status == statuses[1] %}
                    <span class="badge badge-in-progress">{{ request.status }}</span>
                    {% else %}
                    <span class="badge badge-resolved">{{ request.status }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="request-meta">
                <div class="request-meta-item">
                    <strong>Category:</strong> {{ request.category_name }}
                </div>
                <div class="request-meta-item">
                    <strong>Created:</strong> {{ request.created_at }}
                </div>
                <div class="request-meta-item">
                    <strong>Last Updated:</strong> {{ request.updated_at or request.created_at }}
                </div>
            </div>
        </div>
    </div>

    <!-- Status Progress -->
    <div class="card mb-6">
        <div class="card-header">
            <h3>Request Progress</h3>
        </div>
        <div class="card-body">
            <div class="status-progress">
                <!-- Submitted -->
                <div class="status-step {% if request.status in statuses %}completed{% endif %}">
                    <div class="status-step-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 6L9 17l-5-5" />
                        </svg>
                    </div>
                    <span class="status-step-label">Submitted</span>
                </div>

                <!-- In Progress -->
                <div
                    class="status-step {% if request.status == statuses[1] %}active{% elif request.status == statuses[2] %}completed{% endif %}">
                    <div class="status-step-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4" />
                        </svg>
                    </div>
                    <span class="status-step-label">In Progress</span>
                </div>

                <!-- Resolved -->
                <div class="status-step {% if request.status == statuses[2] %}completed{% endif %}">
                    <div class="status-step-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <path d="M9 12l2 2 4-4" />
                        </svg>
                    </div>
                    <span class="status-step-label">Resolved</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Description -->
    <div class="card mb-6">
        <div class="card-header">
            <h3>Description</h3>
        </div>
        <div class="card-body">
            <p style="white-space: pre-wrap; margin: 0;">{{ request.description }}</p>
        </div>
    </div>

    <!-- Feedback Section (only for resolved requests) -->
    {% if request.status == statuses[2] %}
    <div class="card mb-6">
        <div class="card-header">
            <h3>Your Feedback</h3>
        </div>
        <div class="card-body">
            {% if feedback %}
            <!-- Existing Feedback (Read-only) -->
            <div style="text-align: center; padding: 1rem;">
                <div class="star-rating" style="font-size: 2rem; color: #f59e0b; margin-bottom: 1rem;">
                    {{ '★' * feedback.rating }}{{ '☆' * (5 - feedback.rating) }}
                </div>
                {% if feedback.comment %}
                <p style="font-style: italic; color: var(--text-secondary); max-width: 500px; margin: 0 auto;">
                    "{{ feedback.comment }}"
                </p>
                {% endif %}
                <p class="text-muted mt-4" style="font-size: 0.875rem;">
                    Submitted on {{ feedback.submitted_at }}
                </p>
            </div>
            {% elif can_submit_feedback %}
            <!-- Feedback Form -->
            <form method="POST" action="{{ url_for('user.submit_feedback', request_id=request.request_id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group" style="text-align: center;">
                    <label class="form-label" style="font-size: 1rem;">How satisfied are you with the
                        resolution?</label>
                    <div class="star-rating-input" style="margin: 1rem 0;">
                        {% for i in range(5, 0, -1) %}
                        <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                        <label for="star{{ i }}" title="{{ i }} star{% if i != 1 %}s{% endif %}">★</label>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment" class="form-label">Comments (optional)</label>
                    <textarea id="comment" name="comment" class="form-control" rows="3"
                        placeholder="Share your experience or suggestions for improvement..."></textarea>
                </div>

                <div style="text-align: center;">
                    <button type="submit" class="btn btn-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polygon
                                points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" />
                        </svg>
                        Submit Feedback
                    </button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Activity Timeline -->
    <div class="card">
        <div class="card-header">
            <h3>Activity Timeline</h3>
        </div>
        <div class="card-body">
            <div class="timeline">
                {% for log in status_logs %}
                <div class="timeline-item {% if loop.last %}active{% else %}completed{% endif %}">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-time">{{ log.updated_at }}</div>
                        <div class="timeline-title">
                            {% if log.old_status %}
                            Status changed from <strong>{{ log.old_status }}</strong> to <strong>{{ log.new_status
                                }}</strong>
                            {% else %}
                            Request created with status <strong>{{ log.new_status }}</strong>
                            {% endif %}
                        </div>
                        {% if log.remark %}
                        <p class="timeline-text">{{ log.remark }}</p>
                        {% endif %}
                        <div class="timeline-text text-muted">by {{ log.admin_name }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    /* Star Rating Input */
    .star-rating-input {
        display: flex;
        flex-direction: row-reverse;
        justify-content: center;
        gap: 0.25rem;
    }

    .star-rating-input input {
        display: none;
    }

    .star-rating-input label {
        font-size: 2.5rem;
        color: #ddd;
        cursor: pointer;
        transition: color 0.2s;
    }

    .star-rating-input label:hover,
    .star-rating-input label:hover~label,
    .star-rating-input input:checked~label {
        color: #f59e0b;
    }
</style>
{% endblock %}